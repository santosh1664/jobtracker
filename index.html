<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Job Application Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb; }
    * { box-sizing: border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width:1100px; margin:0 auto; padding:24px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .between { justify-content:space-between; align-items:center; }
    .title { font-size:22px; font-weight:700; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 1px 8px rgba(0,0,0,.04); }
    .pad { padding:16px; }
    .kpi { flex:1 1 220px; }
    .kpi .label { font-size:12px; color:var(--muted); }
    .kpi .value { font-size:28px; font-weight:700; margin-top:4px; }
    input,textarea,button,select { border:1px solid var(--border); background:#fff; border-radius:12px; padding:10px 12px; font-size:14px; }
    input,textarea,select { width:100%; }
    input.small { width:200px; }
    textarea { min-height:70px; }
    button { cursor:pointer; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.ghost { background:#fff; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:12px; border-top:1px solid var(--border); vertical-align:top; text-align:left; }
    thead th { background:#f3f4f6; color:#374151; border-top:none; }
    .small { font-size:12px; color:#6b7280; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .flex-1 { flex:1; }
    a.link { color:#2563eb; text-decoration:underline; }
    .auth { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .error { color:#b91c1c; font-size:12px; }
    .ok { color:#047857; font-size:12px; }
    .status-chip { border-radius:999px; padding:4px 10px; font-size:12px; border:1px solid var(--border); display:inline-block; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row between">
      <div class="title">Job Application Tracker</div>
      <div class="actions">
        <!-- Email/Password Auth UI (Register hidden) -->
        <div class="auth" id="authBox">
          <input id="email" class="small" type="email" placeholder="Email" autocomplete="username" />
          <input id="password" class="small" type="password" placeholder="Password" autocomplete="current-password" />
          <button id="loginBtn" class="ghost">Sign in</button>
          <button id="signOutBtn" class="ghost" style="display:none">Sign out</button>
          <span id="authMsg" class="small"></span>
        </div>
        <span id="userTag" class="small">Not signed in</span>
        <button id="exportBtn" class="ghost">Export CSV</button>
        <button id="clearAllBtn" class="ghost">Clear All</button>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <div class="card kpi"><div class="pad"><div class="label">Total Jobs</div><div id="kpi-total" class="value">0</div></div></div>
      <div class="card kpi"><div class="pad"><div class="label">Applied</div><div id="kpi-applied" class="value">0</div></div></div>
      <div class="card kpi"><div class="pad"><div class="label">Not Yet Applied</div><div id="kpi-unapplied" class="value">0</div></div></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="pad">
        <div class="row">
          <div class="flex-1"><input id="f-company" placeholder="Company" /></div>
          <div class="flex-1"><input id="f-role" placeholder="Role / Title" /></div>
          <div class="flex-1"><input id="f-link" placeholder="Link (optional)" /></div>
          <div style="width:220px">
            <select id="f-status" aria-label="Status">
              <option>Wishlist</option>
              <option>Applied</option>
              <option>Interview</option>
              <option>Offer</option>
              <option>Rejected</option>
            </select>
          </div>
          <button id="addBtn" class="primary">Add</button>
        </div>
        <div style="margin-top:10px"><textarea id="f-notes" placeholder="Notes (optional)"></textarea></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="flex-1"><input id="search" placeholder="Search company, role, notes…" /></div>
      <div style="width:220px">
        <select id="statusFilter" aria-label="Filter by status">
          <option value="All">All statuses</option>
          <option>Wishlist</option>
          <option>Applied</option>
          <option>Interview</option>
          <option>Offer</option>
          <option>Rejected</option>
        </select>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="pad" style="padding:0">
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>Status</th><th>Company</th><th>Role</th><th>Date</th><th>Link</th><th>Notes</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="7" class="small" style="text-align:center; padding:24px">Sign in to see your jobs.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="small" style="text-align:center; margin:24px 0 8px">Data is stored securely in your Firebase project (per-user account).</div>
  </div>

  <!-- Firebase SDK (v10 modular) -->
  <script type="module">
    // ==== Your Firebase project (jobt-d9f5b) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBPzBs2FitAa1lvvpfc9HrU_gCu3SKMcow",
      authDomain: "jobt-d9f5b.firebaseapp.com",
      databaseURL: "https://jobt-d9f5b-default-rtdb.firebaseio.com",
      projectId: "jobt-d9f5b",
      storageBucket: "jobt-d9f5b.appspot.com",
      messagingSenderId: "661162100470",
      appId: "1:661162100470:web:d7d3880b0acd6ae58d8ed7",
      measurementId: "G-B8N2Q5D0NN"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence,
      signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    await setPersistence(auth, browserLocalPersistence);

    // UI refs
    const kTotal = document.getElementById('kpi-total');
    const kApplied = document.getElementById('kpi-applied');
    const kUnapplied = document.getElementById('kpi-unapplied');
    const tbody = document.getElementById('tbody');
    const search = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');
    const userTag = document.getElementById('userTag');

    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const authMsg = document.getElementById('authMsg');

    const fCompany = document.getElementById('f-company');
    const fRole = document.getElementById('f-role');
    const fLink = document.getElementById('f-link');
    const fStatus = document.getElementById('f-status');
    const fNotes = document.getElementById('f-notes');

    let jobs = [];
    let uid = null;
    let unsubscribe = null;

    function setAuthMsg(text, ok=false){
      authMsg.textContent = text || '';
      authMsg.className = ok ? 'small ok' : 'small error';
    }

    loginBtn.addEventListener('click', async ()=>{
      setAuthMsg('');
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) return setAuthMsg('Enter email and password');
      try{
        await signInWithEmailAndPassword(auth, email, password);
        setAuthMsg('Signed in', true);
      }catch(e){
        setAuthMsg(e.message || 'Login failed');
      }
    });

    signOutBtn.addEventListener('click', async ()=>{
      setAuthMsg('');
      try{
        await signOut(auth);
        setAuthMsg('Signed out', true);
      }catch(e){
        setAuthMsg(e.message || 'Sign out failed');
      }
    });

    onAuthStateChanged(auth, (user)=>{
      if (unsubscribe) { unsubscribe(); unsubscribe = null; }

      if (!user) {
        uid = null;
        userTag.textContent = 'Not signed in';
        signOutBtn.style.display = 'none';
        jobs = []; render();
        return;
      }

      uid = user.uid;
      userTag.textContent = user.email ? `Signed in • ${user.email}` : `Signed in • ${uid.slice(0,6)}…`;
      signOutBtn.style.display = 'inline-block';

      const jobsRef = ref(db, `users/${uid}/jobs`);
      unsubscribe = onValue(jobsRef, (snap)=>{
        // Default any legacy job without status to 'Wishlist'
        jobs = Object.values(snap.val() || {}).map(j => ({ status: 'Wishlist', ...j }))
               .sort((a,b)=> (b.date||"").localeCompare(a.date||""));
        render();
      }, (err)=> setAuthMsg('DB error: ' + (err?.message || err)));
    });

    // Helpers
    function genId(){ return Math.random().toString(36).slice(2,10); }
    function filteredJobs(){
      const q = (search?.value || '').toLowerCase();
      const sf = statusFilter.value || 'All';
      return jobs.filter(j => {
        const match = (j.company + ' ' + j.role + ' ' + (j.notes||'')).toLowerCase().includes(q);
        const byStatus = (sf === 'All') ? true : (j.status === sf);
        return match && byStatus;
      });
    }

    function render(){
      const total = jobs.length;
      const appliedCount = jobs.filter(j => j.status === 'Applied').length;
      kTotal.textContent = total;
      kApplied.textContent = appliedCount;
      kUnapplied.textContent = total - appliedCount;

      const rows = filteredJobs();
      tbody.innerHTML = '';
      if(rows.length === 0){
        const tr = document.createElement('tr'); const td = document.createElement('td');
        td.colSpan = 7; td.className = 'small'; td.style.textAlign='center'; td.style.padding='24px';
        td.textContent = uid ? 'No jobs found.' : 'Sign in to see your jobs.';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }

      for(const j of rows){
        const tr = document.createElement('tr');

        // STATUS (inline editable)
        const tdS = document.createElement('td');
        const sel = document.createElement('select');
        ['Wishlist','Applied','Interview','Offer','Rejected'].forEach(s=>{
          const o = document.createElement('option'); o.textContent = s; o.value = s;
          if (j.status === s) o.selected = true;
          sel.appendChild(o);
        });
        sel.addEventListener('change', ()=> updateStatus(j.id, sel.value));
        tdS.appendChild(sel); tr.appendChild(tdS);

        // COMPANY
        const tdC = document.createElement('td'); tdC.textContent=j.company; tdC.style.fontWeight='600'; tr.appendChild(tdC);

        // ROLE
        const tdR = document.createElement('td'); tdR.textContent=j.role; tr.appendChild(tdR);

        // DATE
        const tdD = document.createElement('td'); tdD.textContent = j.date ? new Date(j.date).toLocaleDateString() : '—'; tr.appendChild(tdD);

        // LINK
        const tdL = document.createElement('td');
        if(j.link){ const a=document.createElement('a'); a.href=j.link; a.target='_blank'; a.rel='noreferrer'; a.textContent='Open'; a.className='link'; tdL.appendChild(a); }
        else tdL.textContent='—'; tr.appendChild(tdL);

        // NOTES
        const tdN = document.createElement('td'); tdN.textContent=j.notes||'—'; tr.appendChild(tdN);

        // ACTIONS
        const tdAct = document.createElement('td');
        const del = document.createElement('button'); del.textContent='Delete'; del.className='ghost';
        del.addEventListener('click', ()=> removeJob(j.id)); tdAct.appendChild(del); tr.appendChild(tdAct);

        tbody.appendChild(tr);
      }
    }

    // CRUD
    document.getElementById('addBtn').addEventListener('click', async ()=>{
      if(!uid){ setAuthMsg('Please sign in first'); return; }
      const company = fCompany.value.trim();
      const role = fRole.value.trim();
      if(!company || !role) return;
      const id = genId();
      const job = {
        id, company, role,
        link: fLink.value.trim() || '',
        notes: fNotes.value.trim() || '',
        status: fStatus.value || 'Wishlist',
        date: new Date().toISOString()
      };
      try{
        await set(ref(db, `users/${uid}/jobs/${id}`), job);
        fCompany.value=''; fRole.value=''; fLink.value=''; fNotes.value=''; fStatus.value='Wishlist';
      }catch(e){ setAuthMsg('Write failed: ' + (e?.message || e)); }
    });

    async function updateStatus(id, status){
      if(!uid) return;
      try{
        await update(ref(db, `users/${uid}/jobs/${id}`), { status });
      }catch(e){ setAuthMsg('Update failed: ' + (e?.message || e)); }
    }

    async function removeJob(id){
      if(!uid) return;
      if(!confirm('Delete this job?')) return;
      try{ await remove(ref(db, `users/${uid}/jobs/${id}`)); }
      catch(e){ setAuthMsg('Delete failed: ' + (e?.message || e)); }
    }

    // UI controls
    document.getElementById('clearAllBtn').addEventListener('click', async ()=>{
      if(!uid || !jobs.length) return;
      if(!confirm(`Delete ALL ${jobs.length} jobs? This cannot be undone.`)) return;
      try{ await set(ref(db, `users/${uid}/jobs`), null); }
      catch(e){ setAuthMsg('Clear failed: ' + (e?.message || e)); }
    });

    search.addEventListener('input', render);
    statusFilter.addEventListener('change', render);

    // CSV export includes Status
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const header = ['ID','Company','Role','Link','Status','Date','Notes'];
      const escapeCsv = v => {
        v = v ?? '';
        return /[",\n]/.test(v) ? '"' + String(v).replaceAll('"','""') + '"' : String(v);
        };
      const lines = jobs.map(j => [
        j.id, j.company, j.role, j.link||'', j.status || 'Wishlist',
        j.date ? new Date(j.date).toLocaleDateString() : '', j.notes || ''
      ].map(escapeCsv).join(','));
      const csv = [header.join(','), ...lines].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`job-tracker-${new Date().toISOString().slice(0,10)}.csv`; a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
